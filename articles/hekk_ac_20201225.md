---
title: "åƒ•ã®è€ƒãˆãŸæœ€å¼·ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡åŸºç›¤(å®Ÿè·µç·¨)ã€œã¿ã‚“ãªã§ãƒ©ã‚¤ãƒ–ã®å ´åˆã€œ"
emoji: "ðŸ“±"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ã‚²ãƒ¼ãƒ é–‹ç™º", "Redis", "NodeJs"]
publication_name: "happy_elements"
published: true
published_at: 2020-12-25 12:00
---

Happy Elements Advent Calendar 2020 25æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

#æ¦‚è¦
24æ—¥ç›®ã®è¨˜äº‹ã§Redis Streamsã‚’ä½¿ã£ãŸãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡åŸºç›¤ã‚’ä½¿ã†ã«è‡³ã£ãŸçµŒç·¯ã‚’æ›¸ãã¾ã—ãŸã€‚
ä»Šå›žã¯ãƒãƒ³ã‚ºã‚ªãƒ³å½¢å¼ã§å®Ÿéš›ã«Redis Streamsã‚’Pub/Subã¨ã—ã¦ä½¿ã†éƒ¨åˆ†ã‚’æ›¸ã„ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚
ã“ã®è¨˜äº‹ã‚’å…ƒã«Redis Streamsã‚’ä½¿ã£ãŸãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡åŸºç›¤ã‚’å¤šãã®ä¼æ¥­ã§ä½œã£ã¦ã‚‚ã‚‰ãˆãŸã‚‰ã„ã„ãªã¨æ€ã£ã¦ã„ã¾ã™ã€‚

#ç’°å¢ƒ

masOS BigSur 11.0.1
nodebrew 1.0.1
npm 6.14.9
node 14.0.0
redis-server 6.0.9

#WebSocketä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹

ã¾ãšã¯nodeã®åˆæœŸåŒ–ã¨[ws](https://github.com/websockets/ws)ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è¡Œã„ã¾ã™ã€‚

```sh
npm init --yes
npm install ws
```

WebSocketé€šä¿¡ãŒã§ãã‚‹ã‚ˆã†ã«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã¾ã™ã€‚

```javascript:server.js
const WebSocket = require('ws');

const wss = new WebSocket.Server({ port: 8080 });

wss.on('connection', function connection(ws) {
  ws.on('message', function incoming(message) {
    console.log('received: %s', message);
  });

  ws.send('something');
});
```

ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã•ã›ã¾ã™ã€‚

```sh
node server.js
```

WebSocketãŒã¡ã‚ƒã‚“ã¨å‹•ã„ã¦ã„ã‚‹ã®ã‚’ç¢ºèªã—ã¾ã™ã€‚

```sh
wscat -c ws://localhost:8080
```

#Redisã«æŽ¥ç¶šã™ã‚‹

redisã‚’èµ·å‹•ã—ã¾ã™ã€‚

```sh
redis-server
```

[ioredis](https://github.com/luin/ioredis)ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```sh
npm install ioredis
```

ioredisã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```javascript:server.js
const WebSocket = require('ws');
const Redis = require("ioredis");
const redis = new Redis();

const wss = new WebSocket.Server({ port: 8080 });

wss.on('connection', function connection(ws) {
  ws.on('message', function incoming(message) {
    console.log('received: %s', message);
  });

  ws.send('something');
});
```

#Redis Streamsã‚’ä½¿ã£ã¦Subscribeã™ã‚‹

[ioredisã®issue](https://github.com/luin/ioredis/issues/747#issuecomment-500735545)ã‚’å‚è€ƒã«Redis Streamsã‚’ä½¿ã£ã¦Subscribeã—ã¾ã™ã€‚

```javascript:server.js

const WebSocket = require('ws');
const Redis = require("ioredis");
const redis = new Redis();

const wss = new WebSocket.Server({ port: 8080 });

async function subscribeStream(stream, listener) {
  let lastID = '$'

  while (true) {
    // Implement your own `try/catch` logic,
    // (For example, logging the errors and continue to the next loop)
    const reply = await redis.xread('BLOCK', '5000', 'COUNT', 100, 'STREAMS', stream, lastID)
    if (!reply) {
      continue
    }
    const results = reply[0][1]
    const {length} = results
    if (!results.length) {
      continue
    }
    listener(results)
    lastID = results[length - 1][0]
  }
}

subscribeStream('mystream', console.log)

wss.on('connection', function connection(ws) {
  ws.on('message', function incoming(message) {
    console.log('received: %s', message);
  });

  ws.send('something');
});
```

ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¾ã™ã€‚

```sh
node server.js
```

Redisã«æŽ¥ç¶šã—ã€XADDã™ã‚‹ã“ã¨ã§å‹•ä½œç¢ºèªã—ã¾ã™ã€‚

```sh
redis-cli
127.0.0.1:6379> XADD mystream * aaa 1234
```

#Redis Streamsã‚’ä½¿ã£ã¦Publishã™ã‚‹

Publishç”¨ã®Redisã‚’ä½œã‚Šã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’Publishã—ã¾ã™ã€‚

```javascript:server.js
const WebSocket = require('ws');
const Redis = require('ioredis');
const subscriber = new Redis();
const publisher = new Redis();

const wss = new WebSocket.Server({ port: 8080 });

async function subscribeStream(stream, listener) {
  let lastID = '$'

  while (true) {
    // Implement your own `try/catch` logic,
    // (For example, logging the errors and continue to the next loop)
    const reply = await subscriber.xread('BLOCK', '5000', 'COUNT', 100, 'STREAMS', stream, lastID);
    if (!reply) {
      continue;
    }
    const results = reply[0][1];
    const { length } = results;
    if (!results.length) {
      continue;
    }
    listener(results);
    lastID = results[length - 1][0];
  }
}

async function publishStream(stream, message) {
  await publisher.xadd(stream, '*', 'message', message);
}

subscribeStream('mystream', console.log)

wss.on('connection', function connection(ws) {
  ws.on('message', async function incoming(message) {
    await publishStream('mystream', message);
    console.log('publish: ' + message);
  });
});
```

#Redis Streamsã‚’ä»‹ã—ã¦å—ã‘å–ã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚µãƒ¼ãƒãƒ¼å†…ã®å…¨å“¡ã«é€ä¿¡ã™ã‚‹

Subscribeã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã£ãŸæ™‚ã«ã€ã‚µãƒ¼ãƒãƒ¼å†…ã®å…¨å“¡ã«é€ä¿¡ã—ã¾ã™ã€‚

```javascript:server.js
const WebSocket = require('ws');
const Redis = require('ioredis');
const subscriber = new Redis();
const publisher = new Redis();

const wss = new WebSocket.Server({ port: 8080 });

async function subscribeStream(stream, listener) {
  let lastID = '$'

  while (true) {
    // Implement your own `try/catch` logic,
    // (For example, logging the errors and continue to the next loop)
    const reply = await subscriber.xread('BLOCK', '5000', 'COUNT', 100, 'STREAMS', stream, lastID);
    if (!reply) {
      continue;
    }
    const results = reply[0][1];
    const { length } = results;
    if (!results.length) {
      continue;
    }
    listener(results);
    lastID = results[length - 1][0];
  }
}

async function publishStream(stream, message) {
  await publisher.xadd(stream, '*', 'message', message);
}

subscribeStream('mystream', function broadcast(results) {
  results.forEach(result => {
    wss.clients.forEach(function each(client) {
      if (client.readyState === WebSocket.OPEN) {
        client.send(result[1][1]);
      }
    });
  });
});

wss.on('connection', function connection(ws) {
  ws.on('message', async function incoming(message) {
    await publishStream('mystream', message);
  });
});
```

wscatãªã©ã‚’ç”¨ã„ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¤‡æ•°ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã§ã‚„ã‚Šã¨ã‚Šã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

```sh
wscat -c ws://localhost:8080
Connected (press CTRL+C to quit)
> aaa
< aaa
< aaa
< bbb
> ccc
< ccc
```

#Redis Streamsã‚’ä½¿ã£ãŸãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡åŸºç›¤ã®å®Œæˆï¼

ã‚ã¨ã¯ãƒ«ãƒ¼ãƒ ã”ã¨ã«Subscriberã‚’åˆ†ã‘ãŸã‚Šã€Redisã‚¯ãƒ©ã‚¹ã‚¿ã«æŽ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ã—ãŸã‚Šã€ALBã‚’ç”¨æ„ã—ã¦WebSocketã‚µãƒ¼ãƒãƒ¼ã®è² è·åˆ†æ•£ã‚’ã—ãŸã‚Šã™ã‚Œã°å®Œæˆã§ã™ï¼
ã“ã®è¾ºã‚Šã¯Redis Pub/Subã§ã‚‚åŒã˜ãªã®ã§æŒ‘æˆ¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

#ã¾ã¨ã‚

ãƒãƒ³ã‚ºã‚ªãƒ³å½¢å¼ã§Redis Streamsã‚’ä½¿ã£ãŸãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡åŸºç›¤ã®ä½œã‚Šæ–¹ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚
ã‚¹ã‚±ãƒ¼ãƒ«ã™ã‚‹åœ§å€’çš„ã«ç°¡å˜ãªãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡åŸºç›¤ãªã®ã§ã€æ‰‹è»½ã«ä½¿ã„ãŸã„ãƒ‹ãƒ¼ã‚ºã®ã‚ã‚‹æ–¹ã«ã‹ãªã‚Šã‚ªã‚¹ã‚¹ãƒ¡ã ã¨æ€ã£ã¦ã„ã¾ã™ã€‚
(ã‚‚ã£ã¨ã“ã†ã—ãŸæ–¹ãŒã„ã„ãªã©ã‚ã‚Œã°æ•™ãˆã¦ã„ãŸã ã‘ã‚‹ã¨ã¨ã¦ã‚‚å–œã³ã¾ã™)

ã“ã®è¨˜äº‹ã‚’è¦‹ã¦ã€åŒã˜ã‚ˆã†ã«æœ€å¼·ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡åŸºç›¤ã‚’ä½œã£ã¦ã‚‚ã‚‰ãˆã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚
æœ€å¾Œã¾ã§ã”è¦§ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼

# ãƒ¡ãƒ³ãƒãƒ¼å‹Ÿé›†
Happy Elementsæ ªå¼ä¼šç¤¾ ã‚«ã‚«ãƒªã‚¢ã‚¹ã‚¿ã‚¸ã‚ªã§ã¯ã€
ã„ã£ã—ã‚‡ã«ã€ç†±ç‹‚çš„ã«æ„›ã•ã‚Œã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã€‘ã‚’ã¤ãã£ã¦ã„ãŸã ã‘ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ã‚’å¤§å‹Ÿé›†ä¸­ã§ã™ï¼
ã‚‚ã—å¼Šç¤¾ã«ã”èˆˆå‘³æŒã£ã¦ã„ãŸã ã‘ã¾ã—ãŸã‚‰ã€æ˜¯éžä¸€åº¦
ä¸‹è¨˜æŽ¡ç”¨ã‚µã‚¤ãƒˆã‚’ã”è¦§ãã ã•ã„ã€‚
[Happy Elementsæ ªå¼ä¼šç¤¾ æŽ¡ç”¨ç‰¹è¨­ã‚µã‚¤ãƒˆ](https://recruit.happyelements.co.jp/)
